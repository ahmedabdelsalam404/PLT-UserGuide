name: Convert Word Doc to PDF and SVGs

on:
  schedule:
    - cron: "0 6 * * *"  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  convert-doc:
    runs-on: ubuntu-latest

    steps:
    - name: üì• Checkout Repo
      uses: actions/checkout@v3

    - name: üõ† Install LibreOffice and Poppler
      run: |
        sudo apt-get update
        sudo apt-get install -y libreoffice poppler-utils

    - name: üßæ Convert .docx to .pdf
      run: |
        libreoffice --headless --convert-to pdf "PLT-Metrics-Guide.docx" --outdir .
        echo "‚úÖ PDF generated: $(ls -lh PLT-Metrics-Guide.pdf)"

    - name: üñºÔ∏è Convert PDF to SVG pages
      run: |
        mkdir -p svg_pages
        if [ -f "PLT-Metrics-Guide.pdf" ]; then
          echo "‚úÖ PDF found. Detecting page count..."

          PAGES=$(pdfinfo PLT-Metrics-Guide.pdf | grep Pages | awk '{print $2}')
          echo "üìÑ PDF has $PAGES pages"

          # Clean old SVGs
          rm -f svg_pages/*.svg

          # Convert each page to its own SVG
          for i in $(seq 1 $PAGES); do
            echo "Converting page $i..."
            pdftocairo -svg -f $i -l $i PLT-Metrics-Guide.pdf svg_pages/page-$i.svg
          done

          echo "‚úÖ SVGs created:"
          ls -lh svg_pages/
        else
          echo "‚ùå PDF not found!"
          exit 1
        fi

    - name: üßæ Generate index.html to scroll through SVGs
      run: |
        echo "<!DOCTYPE html>
        <html lang='en'>
        <head>
          <meta charset='UTF-8'>
          <meta name='viewport' content='width=device-width, initial-scale=1.0'>
          <title>PLT Metrics Guide</title>
          <style>
            body { margin: 0; font-family: sans-serif; background: #fff; }
            img.page { display: block; margin: 20px auto; max-width: 100%; border: 1px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
          </style>
        </head>
        <body>" > index.html

        for file in svg_pages/page-*.svg; do
          echo "<img src='$file' class='page' alt='$file' />" >> index.html
        done

        echo "</body></html>" >> index.html
        echo "‚úÖ index.html generated."

    - name: üöÄ Commit .pdf, .svg files, and index.html
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git remote set-url origin https://x-access-token:$TOKEN@github.com/${{ github.repository }}

        git stash --include-untracked
        git pull origin main --rebase
        git stash pop || echo "Nothing to pop"

        git add PLT-Metrics-Guide.pdf svg_pages/*.svg index.html
        git commit -m "üìÑ Daily update: PDF and SVGs from Word doc" || echo "Nothing to commit"
        git push origin HEAD:main
