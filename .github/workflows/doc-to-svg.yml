name: Convert Word Doc to PDF and SVGs

on:
  schedule:
    - cron: "15 23 * * *"  # Daily at 11:15 PM UTC (7:15 PM EDT)
  workflow_dispatch:

jobs:
  convert-doc:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install docx2pdf
      run: pip install docx2pdf

    - name: Convert DOCX to PDF using Microsoft Word
      run: |
        python -c "from docx2pdf import convert; convert('PLT-Metrics-Guide.docx')"
        dir

    - name: Install Poppler via Chocolatey
      run: choco install poppler

    - name: Add Poppler to PATH
      run: echo "C:\\ProgramData\\chocolatey\\lib\\poppler\\tools" | Out-File -Append -Encoding ascii $env:GITHUB_PATH

    - name: Convert PDF to SVG pages
      shell: bash
      run: |
        mkdir -p svg_pages
        if [ -f "PLT-Metrics-Guide.pdf" ]; then
          echo "PDF found. Detecting page count..."
          PAGES=$(pdfinfo "PLT-Metrics-Guide.pdf" | grep Pages | awk '{print $2}')
          echo "PDF has $PAGES pages"

          echo "Cleaning old SVGs..."
          rm -f svg_pages/*.svg || true

          for i in $(seq 1 $PAGES); do
            echo "Converting page $i to svg_pages/page-$i.svg"
            pdftocairo -svg -f $i -l $i "PLT-Metrics-Guide.pdf" "svg_pages/page-$i.svg"
          done

          echo "SVGs generated:"
          ls -lh svg_pages/
        else
          echo "PDF not found!"
          exit 1
        fi

    - name: Commit PDF and SVG files
      env:
        TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git remote set-url origin https://x-access-token:$TOKEN@github.com/${{ github.repository }}

        git stash --include-untracked || echo "Nothing to stash"
        git pull origin main --rebase
        git stash pop || echo "Nothing to pop"

        git add PLT-Metrics-Guide.pdf svg_pages/*.svg
        git status
        git commit -m "üìù Daily update: PDF and SVGs from Word doc (docx2pdf)" || echo "Nothing to commit"
        git push origin HEAD:main
